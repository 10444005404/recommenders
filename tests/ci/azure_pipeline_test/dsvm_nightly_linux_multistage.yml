# Copyright (c) Microsoft Corporation. All rights reserved.
# Licensed under the MIT License.
#
# A Github Service Connection must also be created with the name "AI-GitHub"
# https://docs.microsoft.com/en-us/azure/devops/pipelines/process/demands?view=azure-devops&tabs=yaml

resources:
  repositories:
    - repository: aitemplates
      type: github
      name: microsoft/AI
      endpoint: AI-GitHub

schedules:
- cron: "7 0 * * *"
  displayName: Nightly build master
  branches:
    include:
    - master
  always: true
- cron: "7 12 * * *"
  displayName: Nightly build staging
  branches:
    include:
    - staging
  always: true

trigger: none

pr: none

variables:
- group: LinuxAgentPool

stages:
  - stage: "Nightly CPU Test"
    dependsOn: []

    jobs:
    - template: job/linux_test_job.yml
      parameters:
        Agent_Pool: $(Agent_Pool)
        name: nightly
        conda_env: nightly_reco_base
        smoke_tests: true
        integration_tests: true

  - stage: "Nightly GPU Test"
    dependsOn: []

    jobs:
    - template: job/linux_test_job.yml
      parameters:
        Agent_Pool: $(Agent_Pool)
        name: nightly gpu
        conda_env: nightly_reco_gpu
        smoke_tests: true
        integration_tests: true
        gpu: gpu

  - stage: "Nightly Spark Test"
    dependsOn: []

    jobs:
    - template: job/linux_test_job.yml
      parameters:
        Agent_Pool: $(Agent_Pool)
        name: nightly spark
        conda_env: nightly_reco_pyspark
        smoke_tests: true
        integration_tests: true
        spark: spark
